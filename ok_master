#!/bin/bash
# ==============================================================================
# OKnav - Individual Server SSH Handler
# ==============================================================================
#
# SSH connection handler invoked via symlinks. The symlink name (srv1, ok0,
# etc.) is resolved through hosts.conf to determine the target FQDN.
#
# Resolution order:
#   1. Look up symlink name in hosts.conf → FQDN
#   2. If not found, use symlink name directly as hostname (ad-hoc)
#
# Exit codes:
#   0   Success
#   1   General error
#   2   Local-only constraint violated (server restricted to specific host)
#   22  Invalid option (EINVAL)
#   42  Direct execution (must invoke via symlink, not as 'ok_master')
#
# Related:
#   oknav          - Cluster orchestrator (multi-server commands)
#   common.inc.sh  - Shared configuration and functions
#   hosts.conf     - Server definitions (FQDN → alias mappings)
#
# ==============================================================================
set -euo pipefail
shopt -s inherit_errexit shift_verbose extglob nullglob

SCRIPT_PATH=$(realpath -- "$0")
SCRIPT_DIR=${SCRIPT_PATH%/*}
SCRIPT_NAME=${SCRIPT_PATH##*/}
readonly -- SCRIPT_PATH SCRIPT_DIR SCRIPT_NAME

#shellcheck source=common.inc.sh
source "$SCRIPT_DIR"/common.inc.sh || exit 1

# ------------------------------------------------------------------------------
# Configuration (derived from invocation and options)
# ------------------------------------------------------------------------------
declare -- SERVER=${0##*/}         # Target: symlink name, NOT readlink result
declare -- USER=${USER:-root}      # SSH user (current user or root fallback)
declare -- CURDIR=''               # Remote directory (-d preserves PWD)
declare -- CMD=''                  # Remote command (empty = interactive shell)
declare -- SSHOPTS=''              # SSH options (-t for interactive)

usage() {
  cat <<EOT
$SERVER $VERSION - Individual server SSH handler

Usage:
  $SERVER [OPTIONS] [COMMAND...]    Execute command on server
  $SERVER [OPTIONS]                 Start interactive shell

Options:
  -r, --root        Connect as root
  -u, --user USER   Connect as specified user
  -d, --dir         Preserve current working directory
  -D, --debug       Show connection parameters before connecting
  -V, --version     Show version
  -h, --help        Show this help

Examples:
  $SERVER uptime                    Run 'uptime' on server
  $SERVER -r                        Root shell
  $SERVER -rd                       Root shell in current directory
  $SERVER -u deploy git pull        Run as specific user
  $SERVER "df -h | grep data"       Commands with pipes (quote them)

Server Resolution:
  Symlink name '$SERVER' is looked up in hosts.conf to get FQDN.
  If not found, '$SERVER' is used directly as hostname.

EOT
}

# ------------------------------------------------------------------------------
# Option Parsing (supports combined short options: -rd → -r -d)
# ------------------------------------------------------------------------------
while (($#)); do
  case $1 in
    -u|--user)    shift; USER=${1:-"${USER:-}"} ;;
    -r|--root)    USER=root ;;
    -d|--dir)     CURDIR=$PWD ;;
    -D|--debug)   DEBUG=1 ;;
    -V|--version) echo "$SCRIPT_NAME $VERSION"; exit 0 ;;
    -h|--help)    usage; exit 0 ;;

    -[urdDVh]*)
                  # Expand combined options: -rd → -r -d
                  #shellcheck disable=SC2046
                  set -- '' $(printf -- '-%c ' $(grep -o . <<<"${1:1}")) "${@:2}" ;;

    -*)           die 22 "Invalid option ${1@Q}" ;;
    *)            CMD="$*"; break ;;  # Remaining args form the remote command
  esac
  shift
done

# Sanity check: must be invoked via symlink, not directly as 'ok_master'
if [[ $(basename -- "$SERVER") == "$SCRIPT_NAME" ]]; then
  die 42 \
    "Cannot run ${SCRIPT_NAME@Q} directly." '' \
    'Create a symlink with the server name you want to connect to:' \
    "  ln -s $(command -v ok_master || echo /usr/local/bin/ok_master) /usr/local/bin/myserver" '' \
    'Then connect with:' \
    '  myserver uptime' '' \
    'Or use oknav to manage symlinks:' \
    '  oknav add myserver.example.com myserver' \
    '  oknav list'
fi

# ------------------------------------------------------------------------------
# Server Resolution: symlink name → FQDN via hosts.conf
# Returns: 0 found, 1 not found (use as hostname), 2 constraint violation
# ------------------------------------------------------------------------------
load_hosts_conf
declare -- ALIAS="$SERVER"
SERVER=$(resolve_alias "$ALIAS") || {
  case $? in
    1) SERVER="$ALIAS" ;;  # Not in hosts.conf: use alias as hostname
    2) exit 2 ;;           # Local-only constraint violated (error printed)
  esac
}

# ------------------------------------------------------------------------------
# Command Setup: interactive shell vs command execution
# ------------------------------------------------------------------------------
if [[ -z "$CMD" ]]; then
  CMD='exec bash'
  SSHOPTS='-t'  # Pseudo-terminal for interactive session
fi

# Prepend cd if -d option used (path escaped for special chars)
[[ -z "$CURDIR" ]] || CMD="cd $(printf %q "$CURDIR") && $CMD"

# Debug: show connection parameters
if ((DEBUG)); then
  >&2 echo "DEBUG: Connection parameters:"
  >&2 echo "  ALIAS   = $ALIAS"
  >&2 echo "  SERVER  = $SERVER"
  >&2 echo "  USER    = $USER"
  [[ -n "$CURDIR" ]] && >&2 echo "  CURDIR  = $CURDIR"
  >&2 echo "  COMMAND = ${CMD:-<interactive shell>}"
  >&2 echo "  SSH     = ssh $SSHOPTS ${USER}@${SERVER}"
  >&2 echo
fi

# ------------------------------------------------------------------------------
# Execute SSH (exec replaces this process)
# ------------------------------------------------------------------------------
exec /usr/bin/ssh $SSHOPTS "${USER}@${SERVER}" "$CMD"

#fin
